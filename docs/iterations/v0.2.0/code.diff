diff --git a/main.py b/main.py
index 504481c..f508fdd 100644
--- a/main.py
+++ b/main.py
@@ -25,9 +25,57 @@ WEATHERBIT_CITY = os.getenv("WEATHERBIT_CITY", "Maia,PT")
 API_URL = f"https://api.weatherbit.io/v2.0/current?city={WEATHERBIT_CITY}&key={WEATHERBIT_KEY}"
 
 
+DEFAULT_EMAIL_FROM = "estagio.pipeline@example.com"
+DEFAULT_EMAIL_TO = ["pedro.pimenta@cm-maia.pt", "gustavo.sa.martins@gmail.com"]
 
-EMAIL_FROM = "estagio.pipeline@example.com"
-EMAIL_TO = ["pedro.pimenta@cm-maia.pt", "gustavo.sa.martins@gmail.com"]
+DEFAULT_PIPELINE_NAME = "GM-IPMA-METEO"
+
+
+# ====== CONTEXTO (context aware) ======
+
+def get_context():
+    user = os.getenv("PIPELINE_USER", "gustavo")
+    env = os.getenv("PIPELINE_ENV", "local")
+
+    db_config = {
+        "dbname": os.getenv("DB_MAIN_NAME", DEFAULT_DB_CONFIG["dbname"]),
+        "user": os.getenv("DB_MAIN_USER", DEFAULT_DB_CONFIG["user"]),
+        "password": os.getenv("DB_MAIN_PASSWORD", DEFAULT_DB_CONFIG["password"]),
+        "host": os.getenv("DB_MAIN_HOST", DEFAULT_DB_CONFIG["host"]),
+        "port": int(os.getenv("DB_MAIN_PORT", DEFAULT_DB_CONFIG["port"])),
+        "sslmode": os.getenv("DB_MAIN_SSLMODE", DEFAULT_DB_CONFIG["sslmode"]),
+    }
+
+    # Nome da pipeline
+    pipeline_name = os.getenv("PIPELINE_NAME", DEFAULT_PIPELINE_NAME)
+
+    # API URL para IPMA
+    api_url = os.getenv("PIPELINE_API_URL_IPMA", DEFAULT_API_URL)
+
+    # Emails
+    email_from = os.getenv("PIPELINE_EMAIL_FROM", DEFAULT_EMAIL_FROM)
+    email_to_raw = os.getenv(
+        "PIPELINE_EMAIL_TO",
+        ",".join(DEFAULT_EMAIL_TO)
+    )
+    email_to = [e.strip() for e in email_to_raw.split(",") if e.strip()]
+
+    # Endpoint / dashboard onde se podem ver os dados (para p├┤r no email)
+    dashboard_url = os.getenv("PIPELINE_DASHBOARD_URL_METEO", "")
+
+    return {
+        "user": user,
+        "env": env,
+        "db_config": db_config,
+        "pipeline_name": pipeline_name,
+        "api_url": api_url,
+        "email_from": email_from,
+        "email_to": email_to,
+        "dashboard_url": dashboard_url,
+    }
+
+
+# ====== 1. REQUEST / RECEIVE / PARSE ======
 
 def request_data(api_url):
     start = time.time()
@@ -36,6 +84,7 @@ def request_data(api_url):
     elapsed = round(time.time() - start, 2)
     return response.json(), elapsed
 
+
 def receive_data(json_data):
     start = time.time()
     if not json_data:
@@ -43,81 +92,145 @@ def receive_data(json_data):
     elapsed = round(time.time() - start, 2)
     return json_data, elapsed
 
+
 def parse_data(json_data):
     start = time.time()
     parsed = []
 
-    for item in json_data.get("data", []):
-        parsed.append({
-            "fonte": "Weatherbit",
-            "data": item.get("ob_time"),
-            "cidade": item.get("city_name"),
-            "pais": item.get("country_code"),
-            "temp": item.get("temp"),
-            "sensacao_termica": item.get("app_temp"),
-            "humidade": item.get("rh"),
-            "vento": item.get("wind_spd"),
-            "vento_dir": item.get("wind_dir"),
-            "vento_desc": item.get("wind_cdir_full"),
-            "pressao": item.get("pres"),
-            "precipitacao": item.get("precip"),
-            "uv": item.get("uv"),
-            "radiacao_solar": item.get("solar_rad"),
-            "nuvens": item.get("clouds"),
-            "condicao": item.get("weather", {}).get("description"),
-            "estacao": item.get("station"),
-            "nascer_sol": item.get("sunrise"),
-            "por_sol": item.get("sunset"),
-            "lat": item.get("lat"),
-            "lon": item.get("lon")
-        })
+    for timestamp, stations in json_data.items():
+        if not isinstance(stations, dict):
+            continue
+
+        for station_id, values in stations.items():
+            if not isinstance(values, dict):
+                continue
+
+            parsed.append({
+                "fonte": "IPMA",
+                "data": timestamp,
+                "temp": values.get("temperatura"),
+                "humidade": values.get("humidade"),
+                "vento": values.get("intensidadeVento"),
+                "vento_km": values.get("intensidadeVentoKM"),
+                "pressao": values.get("pressao"),
+                "precipitacao": values.get("precAcumulada"),
+                "radiacao": values.get("radiacao"),
+                "id_estacao": station_id,
+                "id_direcc_vento": values.get("idDireccVento"),
+                "lugar": None,
+                "lat": None,
+                "lon": None,
+            })
 
     elapsed = round(time.time() - start, 2)
     return parsed, elapsed
 
-def connect_db():
+
+# ====== 2. LIGA├ç├âO BD (ainda com modo offline) ======
+
+def connect_db(ctx):
     start = time.time()
-    print("Liga├º├úo offline simulada ΓÇö base de dados n├úo utilizada.")
+    db_conf = ctx["db_config"]
+
+    # Se o host ainda ├⌐ "Nao tenho acesso", assumimos modo offline
+    if not db_conf.get("host") or db_conf["host"].lower().startswith("nao"):
+        print("Liga├º├úo offline simulada ΓÇö base de dados n├úo utilizada.")
+        conn = None
+    else:
+        conn = psycopg2.connect(**db_conf)
+        print("Liga├º├úo ├á base de dados estabelecida.")
+
     elapsed = round(time.time() - start, 2)
-    return None, elapsed
+    return conn, elapsed
+
 
 def prepare_query(parsed_data):
     start = time.time()
     query = """
-        INSERT INTO meteo (fonte, data, temp, humidade, vento, pressao, precipitacao, lugar, lat, lon, regdata)
-        VALUES (%(fonte)s, %(data)s, %(temp)s, %(humidade)s, %(vento)s, %(pressao)s, %(precipitacao)s, %(lugar)s, %(lat)s, %(lon)s, NOW())
+        INSERT INTO meteo (
+            fonte, data, temp, humidade, vento, pressao, precipitacao,
+            lugar, lat, lon, regdata
+        )
+        VALUES (
+            %(fonte)s,
+            %(data)s,
+            %(temp)s,
+            %(humidade)s,
+            %(vento)s,
+            %(pressao)s,
+            %(precipitacao)s,
+            %(lugar)s,
+            %(lat)s,
+            %(lon)s,
+            NOW()
+        )
     """
     elapsed = round(time.time() - start, 2)
     return query, elapsed
 
-def execute_query(_, __, parsed_data):
+
+def execute_query(conn, query, parsed_data, ctx):
+    """
+    Mant├⌐m o comportamento original:
+      - se conn for None ΓåÆ guarda em CSV offline
+      - se conn n├úo for None ΓåÆ (podemos mais tarde passar a inserir na BD)
+    """
     start = time.time()
-    df = pd.DataFrame(parsed_data)
-    os.makedirs("offline_output", exist_ok=True)
-    file_path = f"offline_output/meteo_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
-    df.to_csv(file_path, index=False)
+
+    if conn is None:
+        # Modo offline 
+        df = pd.DataFrame(parsed_data)
+        os.makedirs("offline_output", exist_ok=True)
+        file_path = f"offline_output/meteo_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
+        df.to_csv(file_path, index=False)
+        print(f"Dados guardados offline em: {file_path}")
+    else:
+        
+        with conn.cursor() as cur:
+            cur.executemany(query, parsed_data)
+        conn.commit()
+        print(f"Dados inseridos na BD (pipeline {ctx['pipeline_name']}).")
+
     elapsed = round(time.time() - start, 2)
-    print(f"Dados guardados offline em: {file_path}")
     return elapsed
 
-def close_connection(_):
+
+def close_connection(conn):
     start = time.time()
-    print("Fecho de liga├º├úo offline ΓÇö nada a fechar.")
+    if conn is not None:
+        conn.close()
+        print("Liga├º├úo ├á base de dados fechada.")
+    else:
+        print("Fecho de liga├º├úo offline ΓÇö nada a fechar.")
     elapsed = round(time.time() - start, 2)
     return elapsed
 
-def send_summary_email(summary_rows):
+
+# ====== 3. EMAIL ======
+
+def send_summary_email(summary_rows, ctx):
     html_table = tabulate(summary_rows, headers=["Etapa", "Status", "Watch Time (s)"], tablefmt="html")
 
     msg = MIMEMultipart("alternative")
-    msg["Subject"] = "Pipeline Meteo - Relat├│rio de Execu├º├úo"
-    msg["From"] = EMAIL_FROM
-    msg["To"] = ", ".join(EMAIL_TO)
+    msg["Subject"] = f"Pipeline {ctx['pipeline_name']} - Relat├│rio de Execu├º├úo ({ctx['env']})"
+    msg["From"] = ctx["email_from"]
+    msg["To"] = ", ".join(ctx["email_to"])
+
+    extra_info = f"<p>Pipeline: <b>{ctx['pipeline_name']}</b> | Ambiente: <b>{ctx['env']}</b> | Utilizador l├│gico: <b>{ctx['user']}</b></p>"
+
+    # endpoint / dashboard, se existir
+    if ctx["dashboard_url"]:
+        extra_info += f"""
+        <p>Pode verificar os dados em:
+           <a href="{ctx['dashboard_url']}">{ctx['dashboard_url']}</a>
+        </p>
+        """
 
     body = f"""
     <html>
     <body>
         <p><b>Resumo da execu├º├úo da pipeline de meteorologia:</b></p>
+        {extra_info}
         {html_table}
         <br>
         <p>Data/hora de execu├º├úo: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
@@ -133,47 +246,78 @@ def send_summary_email(summary_rows):
     except Exception as e:
         print(f"Falha ao enviar email: {e}")
 
-def pipeline_meteo_normal(api_url):
+
+# ====== 4. PIPELINES ======
+
+def pipeline_meteo_normal(ctx):
     summary = []
+    conn = None
+
     try:
-        data, t1 = request_data(api_url)
+        # Request
+        data, t1 = request_data(ctx["api_url"])
         summary.append(["Request API", "OK", t1])
+
+        # Recep├º├úo
         received, t2 = receive_data(data)
         summary.append(["Recep├º├úo", "OK", t2])
+
+        # Parsing
         parsed, t3 = parse_data(received)
         summary.append(["Parsing", "OK", t3])
-        conn, t4 = connect_db()
+
+        # Liga├º├úo BD
+        conn, t4 = connect_db(ctx)
         summary.append(["Liga├º├úo BD", "OK", t4])
+
+        # Prepara├º├úo Query
         query, t5 = prepare_query(parsed)
         summary.append(["Prepara├º├úo Query", "OK", t5])
-        t6 = execute_query(conn, query, parsed)
+
+        # Execu├º├úo Query (offline CSV ou BD, consoante o contexto)
+        t6 = execute_query(conn, query, parsed, ctx)
         summary.append(["Execu├º├úo Query", "OK", t6])
+
+        # Fecho BD
         t7 = close_connection(conn)
         summary.append(["Fecho BD", "OK", t7])
+
     except Exception as e:
         summary.append(["Erro", f"FAIL ({e})", 0])
     finally:
-        send_summary_email(summary)
+        send_summary_email(summary, ctx)
         print(tabulate(summary, headers=["Etapa", "Status", "Watch Time (s)"]))
 
-def pipeline_meteo_heavy(api_url):
+
+def pipeline_meteo_heavy(ctx):
     summary = []
     conn = None
+
     try:
-        conn, t1 = connect_db()
+        # Liga├º├úo BD primeiro
+        conn, t1 = connect_db(ctx)
         summary.append(["Liga├º├úo BD", "OK", t1])
-        data, t2 = request_data(api_url)
+
+        # Request
+        data, t2 = request_data(ctx["api_url"])
         summary.append(["Request API", "OK", t2])
+
+        # Recep├º├úo
         received, t3 = receive_data(data)
         summary.append(["Recep├º├úo", "OK", t3])
+
+        # Parsing
         parsed, t4 = parse_data(received)
         summary.append(["Parsing", "OK", t4])
+
+        # Prepara├º├úo Query
         query, t5 = prepare_query(parsed)
         summary.append(["Prepara├º├úo Query", "OK", t5])
-        t6 = execute_query(conn, query, parsed)
+
+        # Execu├º├úo Query
+        t6 = execute_query(conn, query, parsed, ctx)
         summary.append(["Execu├º├úo Query", "OK", t6])
-        t7 = close_connection(conn)
-        summary.append(["Fecho BD", "OK", t7])
+
     except Exception as e:
         try:
             if conn:
@@ -182,9 +326,14 @@ def pipeline_meteo_heavy(api_url):
             pass
         summary.append(["Erro", f"FAIL ({e})", 0])
     finally:
-        send_summary_email(summary)
+        if conn:
+            t7 = close_connection(conn)
+            summary.append(["Fecho BD", "OK", t7])
+        send_summary_email(summary, ctx)
         print(tabulate(summary, headers=["Etapa", "Status", "Watch Time (s)"]))
 
+
 if __name__ == "__main__":
-    print("Iniciando pipeline meteorol├│gica (normal)...")
-    pipeline_meteo_normal(API_URL)
+    ctx = get_context()
+    print(f"Iniciando pipeline meteorol├│gica '{ctx['pipeline_name']}' (env={ctx['env']}, user={ctx['user']})...")
+    pipeline_meteo_normal(ctx)
